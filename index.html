<!DOCTYPE html>
<html lang="en">
<head><head>
  <meta charset="utf-8">
  <title>Simple Lottery DApp</title>
  <link rel="stylesheet" href="style.css">
</head>

<meta charset="UTF-8">
<title>üéüÔ∏è Simple Lottery DApp</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
  h1 { text-align: center; color: #222; margin-bottom: 20px; }
  .card { background: #fff; padding: 20px; margin: 15px auto; max-width: 500px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  button { padding: 10px 20px; margin-top: 10px; border-radius: 8px; border: none; cursor: pointer; background-color: #4caf50; color: #fff; font-size: 16px; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  input { padding: 10px; width: 100%; font-size: 16px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; }
  .status { margin-top: 10px; padding: 10px; background: #eef; border-radius: 8px; text-align: center; word-break: break-all; }
  .ticket-list { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin-top: 10px; }
  .ticket { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #eee; }
  .winner { background-color: #fff3cd; font-weight: bold; border-radius: 5px; padding: 3px; }
</style>
</head>
  <meta charset="utf-8">
  <title>Simple Lottery DApp</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<h1>üéüÔ∏è Simple Lottery DApp</h1>

<div class="card">
  <button id="connectBtn">Connect Wallet</button>
  <div class="status" id="walletStatus">Wallet not connected</div>
</div>

<div class="card">
  <p>Current Round: <span id="roundId">-</span></p>
  <p>Round Open: <span id="roundOpen">-</span></p>
  <p>Tickets Sold: <span id="ticketsCount">-</span></p>
</div>

<div class="card">
  <h3>Buy Ticket</h3>
  <input type="number" id="ticketNumber" placeholder="Enter ticket number" />
  <button id="buyBtn">Buy Ticket</button>
  <div class="status" id="buyStatus"></div>
</div>

<div class="card">
  <h3>Pick Winner (Owner)</h3>
  <button id="closeRoundBtn">Close Round</button>
  <button id="pickWinnerBtn">Pick Winner</button>
  <div class="status" id="winnerStatus">
    Winning Ticket: <span id="winningTicket">-</span><br>
    Winner Address: <span id="winnerAddr">-</span><br>
    Payout (ETH): <span id="payout">-</span>
  </div>
</div>

<div class="card">
  <h3>Tickets Bought</h3>
  <div class="ticket-list" id="ticketsList"></div>
</div>

<!-- Ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<script>
// 
const contractAddress = "0x6c7100b1cfa8cf5e006bd5c1047fa917ddedf56e";
const contractABI = [ /* [
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "chosenNumber",
				"type": "uint256"
			}
		],
		"name": "buyTicket",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "closeRound",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "to",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "emergencyWithdraw",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "winnerIndex",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "usePseudoRandom",
				"type": "bool"
			}
		],
		"name": "pickWinner",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint16",
				"name": "_f",
				"type": "uint16"
			}
		],
		"name": "setFeeBps",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_ticketPriceWei",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_maxTickets",
				"type": "uint256"
			},
			{
				"internalType": "uint16",
				"name": "_feeBps",
				"type": "uint16"
			}
		],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "previousOwner",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "OwnershipTransferred",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "renounceOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			}
		],
		"name": "RoundClosed",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			}
		],
		"name": "RoundStarted",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_m",
				"type": "uint256"
			}
		],
		"name": "setMaxTickets",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_p",
				"type": "uint256"
			}
		],
		"name": "setTicketPrice",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "ticketIndex",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			}
		],
		"name": "TicketBought",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "newOwner",
				"type": "address"
			}
		],
		"name": "transferOwnership",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "roundId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "winner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "payout",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "fee",
				"type": "uint256"
			}
		],
		"name": "WinnerPaid",
		"type": "event"
	},
	{
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"stateMutability": "payable",
		"type": "receive"
	},
	{
		"inputs": [],
		"name": "feeBps",
		"outputs": [
			{
				"internalType": "uint16",
				"name": "",
				"type": "uint16"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "maxTickets",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "paid",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "roundId",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "roundOpen",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "ticketPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "tickets",
		"outputs": [
			{
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "number",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "rid",
				"type": "uint256"
			}
		],
		"name": "ticketsCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
] */ ];
// ================================================

let provider, signer, contract;
let currentRound;

async function init() {
    if(!window.ethereum){ alert("MetaMask not installed"); return; }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    contract = new ethers.Contract(contractAddress, contractABI, signer);

    await connectWallet();
    await updateRoundInfo();
    setupEventListeners();
}

async function connectWallet() {
    const accounts = await provider.send("eth_requestAccounts", []);
    document.getElementById("walletStatus").innerText = "Connected: " + accounts[0];
}

async function updateRoundInfo() {
    currentRound = (await contract.roundId()).toNumber();
    document.getElementById("roundId").innerText = currentRound;

    const open = await contract.roundOpen(currentRound);
    document.getElementById("roundOpen").innerText = open;
    document.getElementById("pickWinnerBtn").disabled = open;
    document.getElementById("closeRoundBtn").disabled = !open;

    const count = (await contract.ticketsCount(currentRound)).toNumber();
    document.getElementById("ticketsCount").innerText = count;

    await updateTicketsList();
}

async function updateTicketsList() {
    const listDiv = document.getElementById("ticketsList");
    listDiv.innerHTML = "";
    const count = (await contract.ticketsCount(currentRound)).toNumber();
    for(let i=0;i<count;i++){
        const ticket = await contract.tickets(currentRound, i);
        const div = document.createElement("div");
        div.className = "ticket";
        div.innerHTML = `<span>${ticket.buyer}</span><span>${ticket.number}</span>`;
        listDiv.appendChild(div);
    }
}

// ===== Buy Ticket =====
document.getElementById("buyBtn").onclick = async () => {
    const num = parseInt(document.getElementById("ticketNumber").value);
    if(isNaN(num)){ alert("Enter a valid number"); return; }

    try {
        const price = await contract.ticketPrice();
        const tx = await contract.buyTicket(num, { value: price });
        document.getElementById("buyStatus").innerText = "Buying ticket...";
        await tx.wait();
        document.getElementById("buyStatus").innerText = "Ticket bought!";
        await updateRoundInfo();
    } catch(e){ console.error(e); document.getElementById("buyStatus").innerText = "Error: " + e.message; }
};

// ===== Close Round =====
document.getElementById("closeRoundBtn").onclick = async () => {
    try{ const tx = await contract.closeRound(); await tx.wait(); await updateRoundInfo(); }
    catch(e){ console.error(e); alert(e.message); }
};

// ===== Pick Winner =====
document.getElementById("pickWinnerBtn").onclick = async () => {
    try{
        const tx = await contract.pickWinner(0, true);
        const receipt = await tx.wait();

        const event = receipt.events.find(e => e.event === "WinnerPaid");
        const [rid, winner, payout, fee] = event.args;

        document.getElementById("winnerAddr").innerText = winner;
        document.getElementById("payout").innerText = ethers.utils.formatEther(payout);

        const count = (await contract.ticketsCount(rid)).toNumber();
        let winningNumber = "-";
        for(let i=0;i<count;i++){
            const ticket = await contract.tickets(rid, i);
            if(ticket.buyer.toLowerCase() === winner.toLowerCase()){ winningNumber = ticket.number; break; }
        }
        document.getElementById("winningTicket").innerText = winningNumber;

        await updateRoundInfo();
    } catch(e){ console.error(e); alert(e.message); }
};

// ===== Events =====
function setupEventListeners() {
    contract.on("TicketBought", async (rid, idx, buyer)=>{ if(rid.toNumber()===currentRound) await updateTicketsList(); });
    contract.on("RoundClosed", async (rid)=>{ if(rid.toNumber()===currentRound) await updateRoundInfo(); });
    contract.on("WinnerPaid", async (rid,winner,payout,fee)=>{ if(rid.toNumber()===currentRound) await updateRoundInfo(); });
}

init();
</script>

<script src="script.js"></script>
</body>
</html>
